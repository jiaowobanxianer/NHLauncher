name: Avalonia + ASP.NET Release Build

on:
  push:
    tags:
      - "v*" # 例如 v1.0 或 v1.0.1 时触发

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    strategy:
      matrix:
        configuration: [Release]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # ------------------ NHLauncher.Desktop ------------------
    - name: Restore NHLauncher.Desktop
      run: dotnet restore NHLauncher.Desktop/NHLauncher.Desktop.csproj

    - name: Publish NHLauncher.Desktop (win-x64)
      run: dotnet publish NHLauncher.Desktop/NHLauncher.Desktop.csproj -c ${{ matrix.configuration }} -o publish/NHLauncher.Desktop/win-x64 -r win-x64 --self-contained true

    - name: Zip NHLauncher.Desktop
      run: Compress-Archive -Path publish/NHLauncher.Desktop/win-x64/* -DestinationPath NHLauncher-${{ github.ref_name }}-win-x64.zip


    # ------------------ LauncherPacker ------------------
    - name: Restore LauncherPacker
      run: dotnet restore LauncherPacker/LauncherPacker.csproj

    - name: Publish LauncherPacker (win-x64)
      run: dotnet publish LauncherPacker/LauncherPacker.csproj -c ${{ matrix.configuration }} -o publish/LauncherPacker/win-x64 -r win-x64 --self-contained true

    - name: Zip LauncherPacker
      run: Compress-Archive -Path publish/LauncherPacker/win-x64/* -DestinationPath LauncherPacker-${{ github.ref_name }}-win-x64.zip


    # ------------------ LauncherPackerUploadReceiver ------------------
    - name: Restore LauncherPackerUploadReceiver
      run: dotnet restore LauncherPackerUploadReceiver/LauncherPackerUploadReceiver.csproj

    - name: Publish LauncherPackerUploadReceiver (win-x64)
      run: dotnet publish LauncherPackerUploadReceiver/LauncherPackerUploadReceiver.csproj -c ${{ matrix.configuration }} -o publish/LauncherPackerUploadReceiver/win-x64 -r win-x64 --self-contained true

    - name: Publish LauncherPackerUploadReceiver (linux-x64)
      run: dotnet publish LauncherPackerUploadReceiver/LauncherPackerUploadReceiver.csproj -c ${{ matrix.configuration }} -o publish/LauncherPackerUploadReceiver/linux-x64 -r linux-x64 --self-contained true

    - name: Zip LauncherPackerUploadReceiver
      run: |
        Compress-Archive -Path publish/LauncherPackerUploadReceiver/win-x64/* -DestinationPath LauncherPackerUploadReceiver-${{ github.ref_name }}-win-x64.zip
        Compress-Archive -Path publish/LauncherPackerUploadReceiver/linux-x64/* -DestinationPath LauncherPackerUploadReceiver-${{ github.ref_name }}-linux-x64.zip


    # ------------------ Release ------------------
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        generate_release_notes: true  # ✅ 自动生成 Release Notes
        files: |
          NHLauncher-${{ github.ref_name }}-win-x64.zip
          LauncherPacker-${{ github.ref_name }}-win-x64.zip
          LauncherPackerUploadReceiver-${{ github.ref_name }}-win-x64.zip
          LauncherPackerUploadReceiver-${{ github.ref_name }}-linux-x64.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
